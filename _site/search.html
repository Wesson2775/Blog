<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜索结果</title>
    <link rel="stylesheet" href="/Blog/assets/css/styles.css">
    <link rel="icon" href="/Blog/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="/Blog/assets/js/search.js" defer></script>
</head>
<body>
    <div class="main-container">
        <div class="header">
    <div class="header-top">
        <div class="lang">
            <a href="/Blog/" class="lang-link active">ZH</a>
            <a href="/Blog/index-en.html" class="lang-link">EN</a>
        </div>
    </div>
    <div class="header-middle">
        <h1>An Dabe</h1>
        <p>Seize the day, gather ye rosebuds while ye may.</p>
    </div>
    <div class="header-bottom">
        <nav class="header-bottom-nav">
            <ul>
                <li><a href="/Blog/">首页</a></li>
                <li><a href="/Blog/fragments">随笔</a></li>
                <li><a href="/Blog/friends">友邻</a></li>
                <li><a href="/Blog/tags">标签</a></li>
                <li><a href="/Blog/about">关于</a></li>
            </ul>
        </nav>
        
        
        
    </div>
</div>
        <main class="content">
            <div class="article">
    <h2>搜索结果</h2>
    
    <div id="search-results" aria-live="polite"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const searchResults = document.getElementById('search-results');

    // 使用硬编码路径
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q')?.trim().toLowerCase() || '';
    const searchType = urlParams.get('type') || 'posts';
    const searchJsonPath = searchType === 'fragments' ? '/Blog/fragments-search.json' : '/Blog/search.json';

    if (query) {
        try {
            console.log('尝试加载:', searchJsonPath);
            const res = await fetch(searchJsonPath);
            if (!res.ok) throw new Error(`无法加载 ${searchJsonPath}，状态: ${res.status}`);
            const posts = await res.json();
            console.log(`${searchJsonPath} 加载成功:`, posts.length, '条记录');

            // 模糊搜索和排序
            const terms = query.split(/\s+/);
            const results = posts
                .map(post => {
                    let score = 0;
                    const title = post.title.toLowerCase();
                    const content = post.content.toLowerCase();
                    terms.forEach(term => {
                        if (title.includes(term)) score += 10;
                        if (content.includes(term)) score += 1;
                    });
                    return { post, score };
                })
                .filter(item => item.score > 0)
                .sort((a, b) => b.score - a.score)
                .map(item => item.post);

            // 高亮关键词
            const highlightText = (text) => {
                let result = text;
                terms.forEach(term => {
                    const regex = new RegExp(`(${term})`, 'gi');
                    result = result.replace(regex, '<mark>$1</mark>');
                });
                return result;
            };

            // 渲染结果
            searchResults.innerHTML = results.length
                ? results.map(post => `
                    <div class="search-result-item">
                        <h3><a href="${post.url}">${highlightText(post.title)}</a></h3>
                        <p>${highlightText(post.excerpt || post.content.substring(0, 150))}...</p>
                    </div>
                `).join('')
                : '<p class="no-results">未找到匹配内容</p>';
        } catch (error) {
            console.error('加载搜索索引失败:', error);
            searchResults.innerHTML = '<p class="no-results">搜索出错，请稍后重试</p>';
        }
    } else {
        searchResults.innerHTML = '<p class="no-results">请输入搜索关键词</p>';
    }
});
</script>
        </main>
        <footer class="footer">
    <p>© 2021 - 2025 Dayu ﹒ CC BY-NC-ND 4.0</p>
    <p>
        <a href="/Blog/analytics">Analytics</a> ﹒ 
        <a href="/Blog/feed.xml">RSS</a>
    </p>
</footer>
    </div>
    <button class="back-to-top" aria-label="返回顶部">
        <i class="fas fa-arrow-up"></i>
    </button>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const langLinks = document.querySelectorAll('.lang-link');
            const savedLang = localStorage.getItem('lang') || 'zh';
            
            langLinks.forEach(link => {
                link.classList.toggle('active', link.textContent.toLowerCase() === savedLang);
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.setItem('lang', e.target.textContent.toLowerCase());
                    window.location.href = e.target.href;
                });
            });

            const backToTop = document.querySelector('.back-to-top');
            window.addEventListener('scroll', () => {
                backToTop.classList.toggle('visible', window.scrollY > 300);
            });
            backToTop.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
    </script>
</body>
</html>